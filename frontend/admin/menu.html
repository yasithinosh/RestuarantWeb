<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Management ‚Äì Admin</title>
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>
    <div class="admin-layout">
        <aside class="admin-sidebar">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">üçù</div>
                <div class="sidebar-logo-text">La Bella Cucina<small>Admin Panel</small></div>
            </div>
            <nav class="sidebar-nav">
                <div class="sidebar-nav-section">Main</div>
                <a href="index.html"><i class="fa-solid fa-gauge"></i> Dashboard</a>
                <a href="reservations.html"><i class="fa-solid fa-calendar-check"></i> Reservations</a>
                <a href="menu.html" class="active"><i class="fa-solid fa-utensils"></i> Menu Management</a>
                <a href="orders.html"><i class="fa-solid fa-receipt"></i> Orders</a>
                <div class="sidebar-nav-section">Management</div>
                <a href="staff.html"><i class="fa-solid fa-users"></i> Staff & Users</a>
                <hr
                    style="border:none;border-top:1px solid rgba(255,255,255,0.08);margin:var(--space-sm) var(--space-lg)">
                <a href="../index.html"><i class="fa-solid fa-arrow-left"></i> View Website</a>
            </nav>
            <div class="sidebar-footer">
                <a href="../login.html" onclick="auth.logout()"
                    style="font-size:0.8rem;color:rgba(255,255,255,0.5);display:flex;align-items:center;gap:6px">
                    <i class="fa-solid fa-right-from-bracket"></i> Sign Out
                </a>
            </div>
        </aside>

        <!-- Mobile sidebar overlay -->
        <div class="admin-sidebar-overlay" id="sidebar-overlay" onclick="toggleAdminSidebar()"></div>

        <main class="admin-main">
            <div class="admin-topbar">
                <div class="admin-topbar-left">
                    <button class="admin-mobile-menu-btn" style="display:none" onclick="toggleAdminSidebar()">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                    <h2 class="admin-page-title">Menu Management</h2>
                </div>
                <div class="admin-topbar-actions">
                    <button class="btn btn-primary btn-sm" onclick="openAddModal()">
                        <i class="fa-solid fa-plus"></i> Add Item
                    </button>
                </div>
            </div>
            <div class="admin-content">
                <div class="admin-table-card">
                    <div class="admin-table-header">
                        <div class="admin-search">
                            <i class="fa-solid fa-magnifying-glass"></i>
                            <input type="text" id="search" placeholder="Search menu items‚Ä¶" oninput="searchItems()">
                        </div>
                        <div class="admin-table-filters">
                            <select class="filter-select" id="cat-filter" onchange="filterItems()">
                                <option value="">All Categories</option>
                                <option value="starters">Starters</option>
                                <option value="pasta">Pasta</option>
                                <option value="pizza">Pizza</option>
                                <option value="mains">Mains</option>
                                <option value="desserts">Desserts</option>
                                <option value="drinks">Drinks</option>
                            </select>
                        </div>
                    </div>
                    <div style="overflow-x:auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Available</th>
                                    <th>Featured</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="menu-table-body">
                                <tr>
                                    <td colspan="6" style="text-align:center;padding:var(--space-xl)">
                                        <div class="spinner" style="margin:0 auto"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal-overlay" id="item-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modal-title">Add Menu Item</h3>
                <button class="modal-close" onclick="closeModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-id">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Item Name *</label>
                        <input type="text" id="item-name" class="form-input" required
                            placeholder="e.g. Spaghetti Carbonara">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category *</label>
                        <select id="item-category" class="form-select">
                            <option value="starters">Starters</option>
                            <option value="pasta">Pasta</option>
                            <option value="pizza">Pizza</option>
                            <option value="mains">Mains</option>
                            <option value="desserts">Desserts</option>
                            <option value="drinks">Drinks</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description *</label>
                    <textarea id="item-desc" class="form-textarea" placeholder="Describe the dish‚Ä¶"
                        style="min-height:80px"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Price (ZAR) *</label>
                        <input type="number" id="item-price" class="form-input" min="0" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Item Image</label>
                        <input type="hidden" id="item-image">
                        <!-- Upload area -->
                        <div id="image-upload-area" onclick="document.getElementById('item-image-file').click()"
                            style="border:2px dashed var(--clr-border);border-radius:var(--radius-sm);padding:var(--space-md);text-align:center;cursor:pointer;transition:border-color 0.2s;position:relative;min-height:100px;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:8px;background:#fafafa">
                            <div id="image-upload-placeholder">
                                <i class="fa-solid fa-cloud-arrow-up"
                                    style="font-size:1.8rem;color:var(--clr-muted)"></i>
                                <p style="font-size:0.85rem;color:var(--clr-muted);margin:4px 0 0">Click to upload
                                    image<br><small>JPG, PNG, WebP ¬∑ max 5 MB</small></p>
                            </div>
                            <img id="image-preview" src="" alt="Preview"
                                style="display:none;max-height:140px;max-width:100%;border-radius:var(--radius-sm);object-fit:cover">
                            <div id="upload-spinner" style="display:none">
                                <div class="spinner" style="width:24px;height:24px;border-width:3px"></div>
                                <p style="font-size:0.8rem;color:var(--clr-muted);margin:6px 0 0">Uploading‚Ä¶</p>
                            </div>
                        </div>
                        <input type="file" id="item-image-file" accept="image/*" style="display:none"
                            onchange="uploadImage(this)">
                        <p id="upload-status" style="font-size:0.78rem;margin:4px 0 0;color:var(--clr-muted)"></p>
                        <!-- Fallback: still allow pasting a URL directly -->
                        <input type="url" id="item-image-url-manual" class="form-input"
                            placeholder="Or paste an image URL‚Ä¶" style="margin-top:8px"
                            oninput="setImageFromUrl(this.value)">
                    </div>
                </div>
                <div style="display:flex;gap:var(--space-xl)">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9rem">
                        <input type="checkbox" id="item-available" checked> Available
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:0.9rem">
                        <input type="checkbox" id="item-featured"> Featured
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="save-btn" onclick="saveItem()">
                    <i class="fa-solid fa-floppy-disk"></i> Save Item
                </button>
            </div>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        let allItems = [];

        const CAT_BADGE = {
            starters: 'badge-info', pasta: 'badge-gold', pizza: 'badge-warning',
            mains: 'badge-danger', desserts: 'badge-success', drinks: 'badge-info'
        };

        function renderTable(items) {
            const tbody = document.getElementById('menu-table-body');
            if (!items.length) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><i class="fa-solid fa-bowl-food"></i><h4>No items found</h4></div></td></tr>';
                return;
            }
            tbody.innerHTML = items.map(item => `
      <tr>
        <td><strong>${item.name}</strong>${item.image ? `<br><small style="color:var(--clr-muted)">Has image</small>` : ''}</td>
        <td><span class="badge ${CAT_BADGE[item.category] || 'badge-info'}">${item.category}</span></td>
        <td style="font-weight:700;color:var(--clr-primary)">${formatZAR(item.price)}</td>
        <td>${item.available ? '<span class="badge badge-success">Yes</span>' : '<span class="badge badge-danger">No</span>'}</td>
        <td>${item.featured ? '‚≠ê' : '‚Äî'}</td>
        <td><div class="action-btns">
          <button class="action-btn edit"   onclick='openEditModal(${JSON.stringify(item)})'>‚úèÔ∏è Edit</button>
          <button class="action-btn delete" onclick="deleteItem('${item._id}','${item.name.replace(/'/g, '')}')">üóë Delete</button>
        </div></td>
      </tr>`).join('');
        }

        function searchItems() {
            const q = document.getElementById('search').value.toLowerCase();
            const cat = document.getElementById('cat-filter').value;
            renderTable(allItems.filter(i =>
                (!cat || i.category === cat) &&
                (!q || i.name.toLowerCase().includes(q) || i.description.toLowerCase().includes(q))
            ));
        }
        function filterItems() { searchItems(); }

        async function uploadImage(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];

            // Show spinner, hide placeholder
            document.getElementById('image-upload-placeholder').style.display = 'none';
            document.getElementById('image-preview').style.display = 'none';
            document.getElementById('upload-spinner').style.display = 'flex';
            document.getElementById('upload-status').textContent = '';
            document.getElementById('image-upload-area').style.borderColor = 'var(--clr-gold)';

            try {
                const formData = new FormData();
                formData.append('image', file);

                const token = localStorage.getItem('lb_token');
                const res = await fetch(`${API_BASE}/upload`, {
                    method: 'POST',
                    headers: token ? { Authorization: `Bearer ${token}` } : {},
                    body: formData,
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.error || `Upload failed (${res.status})`);
                }

                const data = await res.json();
                // Store the URL in the hidden field
                document.getElementById('item-image').value = data.url;

                // Show preview
                const preview = document.getElementById('image-preview');
                preview.src = data.url;
                preview.style.display = 'block';
                document.getElementById('upload-status').textContent = '‚úÖ Uploaded: ' + file.name;
                document.getElementById('upload-status').style.color = 'var(--clr-success)';
                document.getElementById('image-upload-area').style.borderColor = 'var(--clr-success)';

            } catch (err) {
                document.getElementById('upload-status').textContent = '‚ùå ' + err.message;
                document.getElementById('upload-status').style.color = 'var(--clr-danger)';
                document.getElementById('image-upload-placeholder').style.display = 'flex';
                document.getElementById('image-upload-area').style.borderColor = 'var(--clr-danger)';
            } finally {
                document.getElementById('upload-spinner').style.display = 'none';
            }
        }

        function setImageFromUrl(url) {
            document.getElementById('item-image').value = url;
            const preview = document.getElementById('image-preview');
            if (url) {
                preview.src = url;
                preview.style.display = 'block';
                document.getElementById('image-upload-placeholder').style.display = 'none';
            } else {
                preview.style.display = 'none';
                document.getElementById('image-upload-placeholder').style.display = 'flex';
            }
        }

        function resetImageUpload() {
            document.getElementById('item-image').value = '';
            document.getElementById('item-image-url-manual').value = '';
            document.getElementById('item-image-file').value = '';
            document.getElementById('image-preview').style.display = 'none';
            document.getElementById('image-preview').src = '';
            document.getElementById('image-upload-placeholder').style.display = 'flex';
            document.getElementById('upload-spinner').style.display = 'none';
            document.getElementById('upload-status').textContent = '';
            document.getElementById('image-upload-area').style.borderColor = 'var(--clr-border)';
        }

        function loadImageIntoUploader(url) {
            document.getElementById('item-image').value = url || '';
            document.getElementById('item-image-url-manual').value = url || '';
            if (url) {
                document.getElementById('image-preview').src = url;
                document.getElementById('image-preview').style.display = 'block';
                document.getElementById('image-upload-placeholder').style.display = 'none';
            } else {
                resetImageUpload();
            }
        }

        function openAddModal() {
            document.getElementById('modal-title').textContent = 'Add Menu Item';
            document.getElementById('edit-id').value = '';
            ['item-name', 'item-desc'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('item-price').value = '';
            document.getElementById('item-available').checked = true;
            document.getElementById('item-featured').checked = false;
            document.getElementById('item-category').value = 'pasta';
            resetImageUpload();
            document.getElementById('item-modal').classList.add('open');
        }

        function openEditModal(item) {
            document.getElementById('modal-title').textContent = 'Edit Menu Item';
            document.getElementById('edit-id').value = item._id;
            document.getElementById('item-name').value = item.name;
            document.getElementById('item-desc').value = item.description;
            document.getElementById('item-price').value = item.price;
            document.getElementById('item-category').value = item.category;
            document.getElementById('item-available').checked = item.available;
            document.getElementById('item-featured').checked = item.featured;
            loadImageIntoUploader(item.image || '');
            document.getElementById('item-modal').classList.add('open');
        }

        function closeModal() { document.getElementById('item-modal').classList.remove('open'); }

        async function saveItem() {
            const id = document.getElementById('edit-id').value;
            const body = {
                name: document.getElementById('item-name').value,
                description: document.getElementById('item-desc').value,
                price: parseFloat(document.getElementById('item-price').value),
                image: document.getElementById('item-image').value,
                category: document.getElementById('item-category').value,
                available: document.getElementById('item-available').checked,
                featured: document.getElementById('item-featured').checked,
            };
            if (!body.name || !body.description || isNaN(body.price)) {
                showToast('Please fill in all required fields', 'error'); return;
            }
            const btn = document.getElementById('save-btn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving‚Ä¶';
            btn.disabled = true;
            try {
                if (id) await api.updateItem(id, body);
                else await api.createItem(body);
                showToast(id ? 'Item updated!' : 'Item added!');
                closeModal(); loadMenu();
            } catch (e) {
                showToast(e.message, 'error');
            }
            btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Save Item';
            btn.disabled = false;
        }

        async function deleteItem(id, name) {
            if (!confirm(`Delete "${name}"?`)) return;
            try { await api.deleteItem(id); showToast('Deleted'); loadMenu(); }
            catch (e) { showToast(e.message, 'error'); }
        }

        async function loadMenu() {
            try {
                allItems = await api.getMenuAdmin();
                renderTable(allItems);
            } catch {
                document.getElementById('menu-table-body').innerHTML = '<tr><td colspan="6" style="text-align:center;padding:var(--space-xl);color:var(--clr-muted)">Backend offline ‚Äî connect to see live data</td></tr>';
            }
        }
        loadMenu();

        function toggleAdminSidebar() {
            document.querySelector('.admin-sidebar').classList.toggle('open');
            document.getElementById('sidebar-overlay').classList.toggle('open');
        }
    </script>
</body>

</html>