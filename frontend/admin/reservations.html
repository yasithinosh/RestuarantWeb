<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reservations ‚Äì Admin</title>
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="../css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>
    <div class="admin-layout">
        <aside class="admin-sidebar">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">üçù</div>
                <div class="sidebar-logo-text">La Bella Cucina<small>Admin Panel</small></div>
            </div>
            <nav class="sidebar-nav">
                <div class="sidebar-nav-section">Main</div>
                <a href="index.html"><i class="fa-solid fa-gauge"></i> Dashboard</a>
                <a href="reservations.html" class="active"><i class="fa-solid fa-calendar-check"></i> Reservations</a>
                <a href="menu.html"><i class="fa-solid fa-utensils"></i> Menu Management</a>
                <a href="orders.html"><i class="fa-solid fa-receipt"></i> Orders</a>
                <div class="sidebar-nav-section">Management</div>
                <a href="staff.html"><i class="fa-solid fa-users"></i> Staff & Users</a>
                <hr
                    style="border:none;border-top:1px solid rgba(255,255,255,0.08);margin:var(--space-sm) var(--space-lg)">
                <a href="../index.html"><i class="fa-solid fa-arrow-left"></i> View Website</a>
            </nav>
            <div class="sidebar-footer">
                <a href="../login.html" onclick="auth.logout()"
                    style="font-size:0.8rem;color:rgba(255,255,255,0.5);display:flex;align-items:center;gap:6px">
                    <i class="fa-solid fa-right-from-bracket"></i> Sign Out
                </a>
            </div>
        </aside>

        <!-- Mobile sidebar overlay -->
        <div class="admin-sidebar-overlay" id="sidebar-overlay" onclick="toggleAdminSidebar()"></div>

        <main class="admin-main">
            <div class="admin-topbar">
                <div class="admin-topbar-left">
                    <button class="admin-mobile-menu-btn" style="display:none" onclick="toggleAdminSidebar()">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                    <h2 class="admin-page-title">Reservations</h2>
                </div>
                <div class="admin-topbar-actions">
                    <span id="res-count" style="font-size:0.85rem;color:var(--clr-muted)"></span>
                </div>
            </div>
            <div class="admin-content">

                <!-- Mini stats -->
                <div class="admin-stats-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:var(--space-xl)">
                    <div class="admin-stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-card-value" id="s-total">‚Äî</div>
                                <div class="stat-card-label">Total</div>
                            </div>
                            <div class="stat-card-icon blue"><i class="fa-solid fa-calendar"></i></div>
                        </div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-card-value" id="s-pending">‚Äî</div>
                                <div class="stat-card-label">Pending</div>
                            </div>
                            <div class="stat-card-icon gold"><i class="fa-solid fa-clock"></i></div>
                        </div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-card-value" id="s-confirmed">‚Äî</div>
                                <div class="stat-card-label">Confirmed</div>
                            </div>
                            <div class="stat-card-icon green"><i class="fa-solid fa-circle-check"></i></div>
                        </div>
                    </div>
                    <div class="admin-stat-card">
                        <div class="stat-card-header">
                            <div>
                                <div class="stat-card-value" id="s-cancelled">‚Äî</div>
                                <div class="stat-card-label">Cancelled</div>
                            </div>
                            <div class="stat-card-icon red"><i class="fa-solid fa-circle-xmark"></i></div>
                        </div>
                    </div>
                </div>

                <div class="admin-table-card">
                    <div class="admin-table-header">
                        <div class="admin-search">
                            <i class="fa-solid fa-magnifying-glass"></i>
                            <input type="text" id="search" placeholder="Search by name or email‚Ä¶" oninput="searchRes()">
                        </div>
                        <div class="admin-table-filters">
                            <select class="filter-select" id="status-filter" onchange="loadReservations()">
                                <option value="">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <input type="date" id="date-filter" class="filter-select" onchange="loadReservations()">
                        </div>
                    </div>
                    <div style="overflow-x:auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Guest</th>
                                    <th>Contact</th>
                                    <th>Date</th>
                                    <th>Time</th>
                                    <th>Guests</th>
                                    <th>Notes</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="res-tbody">
                                <tr>
                                    <td colspan="8" style="text-align:center;padding:var(--space-xl)">
                                        <div class="spinner" style="margin:0 auto"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/auth.js"></script>
    <script>
        let allRes = [];
        const SB = {
            pending: '<span class="badge badge-warning">Pending</span>',
            confirmed: '<span class="badge badge-success">Confirmed</span>',
            cancelled: '<span class="badge badge-danger">Cancelled</span>',
        };

        function renderRes(items) {
            const tbody = document.getElementById('res-tbody');
            document.getElementById('res-count').textContent = `${items.length} reservation(s)`;
            if (!items.length) {
                tbody.innerHTML = '<tr><td colspan="8"><div class="empty-state"><i class="fa-solid fa-calendar-xmark"></i><h4>No reservations found</h4></div></td></tr>';
                return;
            }
            tbody.innerHTML = items.map(r => `
      <tr>
        <td><strong>${r.name}</strong></td>
        <td>${r.email}<br><small>${r.phone}</small></td>
        <td>${formatDate(r.date)}</td>
        <td>${r.time}</td>
        <td>${r.guests}</td>
        <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:0.82rem;color:var(--clr-muted)">${r.notes || '‚Äî'}</td>
        <td>${SB[r.status] || r.status}</td>
        <td><div class="action-btns">
          ${r.status !== 'confirmed' ? `<button class="action-btn confirm" onclick="updateStatus('${r._id}','confirmed')">‚úì Confirm</button>` : ''}
          ${r.status !== 'cancelled' ? `<button class="action-btn cancel"  onclick="updateStatus('${r._id}','cancelled')">‚úó Cancel</button>` : ''}
          <button class="action-btn delete" onclick="deleteRes('${r._id}')">üóë</button>
        </div></td>
      </tr>`).join('');
        }

        function searchRes() {
            const q = document.getElementById('search').value.toLowerCase();
            renderRes(allRes.filter(r => r.name.toLowerCase().includes(q) || r.email.toLowerCase().includes(q)));
        }

        async function updateStatus(id, status) {
            try { await api.updateReservation(id, { status }); showToast(`Status ‚Üí ${status}`); loadReservations(); }
            catch (e) { showToast(e.message, 'error'); }
        }

        async function deleteRes(id) {
            if (!confirm('Delete this reservation?')) return;
            try { await api.deleteReservation(id); showToast('Deleted'); loadReservations(); }
            catch (e) { showToast(e.message, 'error'); }
        }

        async function loadReservations() {
            const status = document.getElementById('status-filter').value;
            const date = document.getElementById('date-filter').value;
            let q = [];
            if (status) q.push(`status=${status}`);
            if (date) q.push(`date=${date}`);
            try {
                allRes = await api.getReservations(q.length ? '?' + q.join('&') : '');
                renderRes(allRes);
                // Load stats
                const stats = await api.getReservationStats();
                document.getElementById('s-total').textContent = stats.total;
                document.getElementById('s-pending').textContent = stats.pending;
                document.getElementById('s-confirmed').textContent = stats.confirmed;
                document.getElementById('s-cancelled').textContent = stats.cancelled;
            } catch {
                document.getElementById('res-tbody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:var(--space-xl);color:var(--clr-muted)">Backend offline</td></tr>';
            }
        }
        loadReservations();

        function toggleAdminSidebar() {
            document.querySelector('.admin-sidebar').classList.toggle('open');
            document.getElementById('sidebar-overlay').classList.toggle('open');
        }
    </script>
</body>

</html>